# 修复 ES7210 初始化问题

## 1. 问题分析

*   **报错信息**:
    *   `E (2243) i2c.master: I2C transaction unexpected nack detected`
    *   `E (2263) I2C_If: Fail to write to dev 40`
    *   `E (2453) ES7210: Write register fail`
    *   `E (2453) ES7210: Open fail`
*   **根本原因**:
    *   ES7210 的 I2C 地址不正确。
    *   Tab5 的原理图和官方 BSP 显示 ES7210 的地址是 `0x40` (I2C 扫描结果也可能证实或证伪这一点，但根据日志，它在写 `0x40` 时 NACK)。
    *   然而，查看 `es7210_adc.h`，默认地址是 `0x80`。
    *   **关键发现**: 在官方 BSP `m5stack_tab5.c` 中，`bsp_audio_codec_microphone_init` 函数调用 `audio_codec_new_i2c_ctrl` 时，传递的地址是 `ES7210_CODEC_DEFAULT_ADDR`。
    *   在 `es7210_adc.h` 中，`ES7210_CODEC_DEFAULT_ADDR` 定义为 `0x80`。
    *   但是！我在 `tab5.cpp` 中手动 `#undef` 并定义为了 `0x40`。
    *   如果设备实际地址是 `0x40`，那么写入 `0x40` 应该成功。如果失败，可能是地址错误（也许应该是 `0x41` 或 `0x80`），或者时序问题。
    *   **I2C 扫描结果**: 用户日志中提到 `I (2173) | M5StackTab5 | I2C | Bus |: Scan complete. Found 10 devices.` 但没有列出具体地址。这很关键。如果 0x40 不在列表中，那我们就用错地址了。
    *   **配置参数差异**:
        *   官方 BSP 使用 `ES7210_SEL_MIC1 | ES7210_SEL_MIC2`。
        *   官方 BSP 没有设置 `master_mode`，默认为 false。
        *   官方 BSP 没有设置 `mclk_src` 和 `mclk_div`。

## 2. 解决方案

### A. 确认 I2C 地址
由于日志显示写 `0x40` 失败，我们需要尝试官方 BSP 默认的 `0x80` (即不覆盖宏定义)，或者 `0x41`, `0x42` 等。
鉴于官方 BSP 也是引用 `es7210_adc.h` 中的 `0x80`，我们应该尝试改回 `0x80`。

### B. 对齐初始化参数
修改 `src/board/m5stack/tab5.cpp` 中的 `mic_codec_new_func`，使其与官方 BSP `bsp_audio_codec_microphone_init` 完全一致：
1.  **I2C 地址**: 尝试改回 `0x80` (或者先注释掉 `#undef`，使用默认值)。
2.  **配置结构体**:
    *   移除 `master_mode` (默认 false)。
    *   移除 `mclk_src` 和 `mclk_div` (默认值)。
    *   保留 `mic_selected` (MIC1 | MIC2)。

## 3. 执行计划
1.  修改 `src/board/m5stack/tab5.cpp`:
    *   注释掉 `#undef ES7210_CODEC_DEFAULT_ADDR` 和 `#define ES7210_CODEC_DEFAULT_ADDR (0x40)`，恢复使用默认的 `0x80`。
    *   精简 `es7210_codec_cfg_t` 配置，只保留 `ctrl_if`。官方 BSP 在 `m5stack_tab5.c:464` 甚至没有设置 `mic_selected` (这意味着使用默认值，可能是全部开启或只开启 MIC1)。
    *   *修正*: 仔细看 `m5stack_tab5.c` 的第 464 行：
        ```c
        es7210_codec_cfg_t codec_cfg = {
            .ctrl_if = i2c_ctrl_if,
        };
        ```
        它**没有**设置 `mic_selected`！这意味着它使用 0 (默认值)。而我的代码设置了 `ES7210_SEL_MIC1 | ES7210_SEL_MIC2`。
2.  修改 `i2s_bus_config` 中的 `dma_frame_num` 为 512 (可选，优化警告)。

## 4. 验证
编译烧录，观察：
1.  I2C 写 `0x80` 是否成功。
2.  ES7210 是否初始化成功。
