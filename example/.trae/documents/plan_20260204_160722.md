# 修复显示屏颜色异常问题

## 1. 问题分析

*   **现象**: 显示屏将白色显示为淡紫色。
*   **原因分析**:
    *   通常 LCD 颜色异常（如白色偏色、反色等）与以下因素有关：
        1.  **像素格式不匹配**: RGB565 vs RGB666 vs RGB888。
        2.  **字节序 (Endianness)**: Big Endian vs Little Endian。
        3.  **色彩反转 (Inversion)**: 许多 IPS 屏需要开启色彩反转。
        4.  **Gamma 曲线**: 初始化序列中的 Gamma 设置不正确。
    *   **代码对比**:
        *   **初始化序列**: `tab5.cpp` 中的 `disp_init_data` 看起来是从官方 `disp_init_data.h` 复制的，但需要仔细核对是否有差异。
        *   **色彩格式**:
            *   `tab5.cpp`:
                *   `pixel_format = LCD_COLOR_PIXEL_FORMAT_RGB565`
                *   `in_color_format = LCD_COLOR_FMT_RGB565`
                *   `out_color_format = LCD_COLOR_FMT_RGB565`
                *   `data_endian = LCD_RGB_DATA_ENDIAN_BIG`
                *   `rgb_ele_order = LCD_RGB_ELEMENT_ORDER_RGB`
            *   官方 `m5stack_tab5.c`:
                *   `in_color_format = LCD_COLOR_FMT_RGB565`
                *   `rgb_ele_order = BSP_LCD_COLOR_SPACE` (通常是 RGB)
                *   `bits_per_pixel = BSP_LCD_BITS_PER_PIXEL` (16)
                *   `swap_bytes`: LVGL 配置中 `BSP_LCD_BIGENDIAN ? true : false`。
        *   **关键差异点**:
            *   官方 BSP 在 `bsp_display_new_with_handles` 函数中显式调用了：
                ```c
                esp_lcd_panel_invert_color(ret_handles->panel, false);
                esp_lcd_panel_swap_xy(ret_handles->panel, false);
                esp_lcd_panel_mirror(ret_handles->panel, false, false);
                ```
            *   在 `tab5.cpp` 中，我没有看到显式调用 `esp_lcd_panel_invert_color`。
            *   ILI9881C 驱动默认可能开启或关闭了反转。如果屏幕需要反转而未设置，或者不需要反转却设置了，就会导致颜色异常（如黑色变白，白色变黑，或者颜色怪异）。
            *   如果白色显示为淡紫色，很可能是缺色或者反转设置错误。
            *   另外，官方 BSP 的 `lvgl_port_display_cfg_t` 中设置了 `swap_bytes = true` (如果 `BSP_LCD_BIGENDIAN` 为真)。
            *   `tab5.cpp` 中 `LvglDisplayConfig` 的 `swap_bytes` 设置为 `true`。

## 2. 解决方案

### A. 检查并添加色彩反转设置
在 `tab5.cpp` 的 `Init()` 方法中，在 `ili9881c.Init(...)` 之后，显式调用 `esp_lcd_panel_invert_color(panel_handle, false)`。虽然官方代码传的是 `false` (不反转)，但如果默认是反转的，这行代码可能很重要。或者，如果官方代码里 `false` 是因为驱动内部逻辑，我们也应该加上。
*更正*: 官方代码调用了 `esp_lcd_panel_invert_color(..., false)`。这意味着它强制关闭了反转。ILI9881C 驱动初始化时通常会执行 `21h` (Display Inversion On) 或 `20h` (Display Inversion Off)。我们需要确认初始化序列中的命令。
在 `disp_init_data.h` 中，可以看到 `0x21` (Display Inversion On) 被发送了 (`{0x21, (uint8_t[]){0x01}, 1, 0},`)。
如果官方代码随后调用 `invert_color(..., false)`，这实际上是发送 `0x20` 命令来关闭反转，或者覆盖之前的设置。
**行动**: 在 `tab5.cpp` 中添加 `esp_lcd_panel_invert_color(panel_handle, false);`。

### B. 检查初始化序列差异
对比 `tab5.cpp` 和 `disp_init_data.h` 的内容。
*   `disp_init_data.h`:
    ```c
    {0x21, (uint8_t[]){0x01}, 1, 0},
    ```
*   `tab5.cpp`:
    ```cpp
    {0x21, (uint8_t[]){0x01}, 1, 0},
    ```
两者都有 `0x21`。
但是官方 BSP 在初始化后调用了 `esp_lcd_panel_invert_color(..., false)`。这可能会发送 `0x20`。
如果屏幕实际上不需要反转，但初始化序列开启了反转，颜色就会不对。
尝试添加 `esp_lcd_panel_invert_color(panel_handle, false)`。

### C. 检查 RGB 顺序
`tab5.cpp` 使用 `LCD_RGB_ELEMENT_ORDER_RGB`。
官方 BSP 使用 `BSP_LCD_COLOR_SPACE`。通常也是 RGB。
如果颜色偏紫（Magenta），可能是 Green 通道丢失或弱，或者 Blue/Red 通道过强。
如果是淡紫色代替白色，说明 Green 分量不足。
RGB565 中，Green 占 6 位。字节交换错误也可能导致颜色怪异。

## 3. 执行计划
1.  修改 `src/board/m5stack/tab5.cpp`:
    *   在 `ili9881c.Init` 之后，`esp_lcd_panel_disp_on_off` 之前，添加：
        ```cpp
        esp_lcd_panel_invert_color(panel_handle, false);
        esp_lcd_panel_swap_xy(panel_handle, false);
        esp_lcd_panel_mirror(panel_handle, false, false);
        ```
    *   这三行在官方 BSP 中都有。特别是 `invert_color(false)` 可能会抵消初始化序列中的 `0x21`。

2.  如果上述无效，可能需要尝试 `invert_color(true)`。但在官方代码用 `false` 的情况下，先试 `false`。

## 4. 验证
编译烧录，观察屏幕白色显示是否正常。
